#!/usr/bin/env bash
# Pre-commit hook: format check and clippy
#
# Install: cp scripts/pre-commit .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit

set -e

echo "Running cargo fmt check..."
cargo fmt --check

echo "Running cargo clippy..."
cargo clippy --all-targets --all-features -- -D warnings 2>/dev/null || {
    echo "  Warning: clippy check failed or not available (non-critical)"
}

# Run normalize rules if binary exists
if [ -x "./target/release/normalize" ] || [ -x "./target/debug/normalize" ]; then
    NORMALIZE="${NORMALIZE:-./target/release/normalize}"
    [ -x "$NORMALIZE" ] || NORMALIZE="./target/debug/normalize"

    if [ -x "$NORMALIZE" ]; then
        echo "Running normalize rules..."
        $NORMALIZE analyze rules --rule rust/tuple-return crates/ || {
            echo "  Error: tuple return rule violations found"
            exit 1
        }
    fi
fi

echo "Pre-commit checks passed!"
