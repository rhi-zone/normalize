name: CI

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]

jobs:
  check:
    name: Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Cache Bun
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: bun-${{ runner.os }}-${{ hashFiles('web/sessions/bun.lock') }}
          restore-keys: |
            bun-${{ runner.os }}-

      - name: Install sessions SPA deps
        run: bun install
        working-directory: web/sessions

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: "crates -> target"

      - name: Run cargo check
        run: cargo check --workspace --all-features

  fmt:
    name: Format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt

      - name: Check formatting
        run: cargo fmt --all -- --check

  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Cache Bun
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: bun-${{ runner.os }}-${{ hashFiles('web/sessions/bun.lock') }}
          restore-keys: |
            bun-${{ runner.os }}-

      - name: Install sessions SPA deps
        run: bun install
        working-directory: web/sessions

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: "crates -> target"

      - name: Run clippy
        run: cargo clippy --workspace --all-features -- -D warnings

  test:
    name: Test & Clone Detection
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Cache Bun
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: bun-${{ runner.os }}-${{ hashFiles('web/sessions/bun.lock') }}
          restore-keys: |
            bun-${{ runner.os }}-

      - name: Install sessions SPA deps
        run: bun install
        working-directory: web/sessions

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: "crates -> target"

      - name: Cache grammars
        id: grammar-cache
        uses: actions/cache@v4
        with:
          path: target/grammars
          key: grammars-linux-${{ hashFiles('Cargo.lock', 'xtask/src/**') }}

      - name: Fetch dependencies
        run: cargo fetch

      - name: Build grammars
        if: steps.grammar-cache.outputs.cache-hit != 'true'
        run: cargo xtask build-grammars

      - name: Run tests
        run: cargo test --workspace
        env:
          NORMALIZE_GRAMMAR_PATH: ${{ github.workspace }}/target/grammars

      - name: Build normalize
        run: cargo build --release -p rhi-normalize

      - name: Check for code clones
        run: |
          # --min-lines 15: Functions under 15 lines are often simple patterns
          # (constructors, getters, trait impls) where duplication is acceptable.
          # Above 15 lines usually indicates extractable shared logic.
          ./target/release/normalize analyze duplicate-functions --min-lines 15

          # --min-overlap 90: Overlap = common_fields / smaller_type_fields.
          # Small types (e.g., Position{line,column}) match any type with those
          # fields, causing false positives. 90% filters coincidental matches
          # while catching genuinely duplicated domain types.
          ./target/release/normalize analyze duplicate-types --min-overlap 90
        env:
          NORMALIZE_GRAMMAR_PATH: ${{ github.workspace }}/target/grammars

      - name: Check syntax rules
        run: |
          # Dogfood our own rules - tuple returns should use named structs
          ./target/release/normalize analyze rules --rule rust/tuple-return crates/
        env:
          NORMALIZE_GRAMMAR_PATH: ${{ github.workspace }}/target/grammars

  benchmark:
    name: Benchmark
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Cache Bun
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: bun-${{ runner.os }}-${{ hashFiles('web/sessions/bun.lock') }}
          restore-keys: |
            bun-${{ runner.os }}-

      - name: Install sessions SPA deps
        run: bun install
        working-directory: web/sessions

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: "crates -> target"

      - name: Build release
        run: cargo build --release -p rhi-normalize

      - name: Run benchmarks
        run: |
          ./crates/normalize/bench.sh --quick 2>&1 | tee benchmark-results.txt

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: benchmark-results.txt

      - name: Check for major regressions
        run: |
          # Parse results and check against thresholds
          # Fast commands should be < 50ms, slow commands < 1000ms
          python3 << 'EOF'
          import re
          import sys

          thresholds = {
              "path": 50,
              "expand": 50,
              "callers": 50,
              "callees": 50,
              "search-tree": 50,
              "tree": 100,
              "symbols": 100,
              "skeleton": 100,
              "complexity": 100,
              "deps": 100,
              "anchors": 100,
              "summarize": 150,
              "health": 1000,
          }

          with open("benchmark-results.txt") as f:
              content = f.read()

          failures = []
          for line in content.split("\n"):
              match = re.match(r"(\S+)\s+(\d+)\s*ms", line.strip())
              if match:
                  name, ms = match.groups()
                  ms = int(ms)
                  # Find matching threshold (prefix match)
                  for key, threshold in thresholds.items():
                      if name.startswith(key):
                          if ms > threshold:
                              failures.append(f"{name}: {ms}ms > {threshold}ms threshold")
                          break

          if failures:
              print("Benchmark regressions detected:")
              for f in failures:
                  print(f"  - {f}")
              sys.exit(1)
          else:
              print("All benchmarks within thresholds")
          EOF

  public-api:
    name: Public API
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Rust
        uses: dtolnay/rust-toolchain@nightly
        with:
          components: rustfmt

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: "crates -> target"

      - name: Install cargo-public-api
        run: cargo install cargo-public-api

      - name: Check public API diff
        run: |
          # Compare public API between PR branch and base
          cargo public-api diff ${{ github.event.pull_request.base.sha }}..${{ github.sha }} \
            --deny changed --deny removed \
            -p rhi-normalize
